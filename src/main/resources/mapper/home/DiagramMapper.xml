<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sinopec.smcc.cpro.home.mapper.DiagramMapper">
  <resultMap id="DiagramResult" type="com.sinopec.smcc.cpro.home.entity.DiagramResult">
    <result column="level1" property="level1" jdbcType="INTEGER" />
    <result column="level2" property="level2" jdbcType="INTEGER" />
    <result column="level3" property="level3" jdbcType="INTEGER" />
    <result column="level4" property="level4" jdbcType="INTEGER" />
    <result column="level5" property="level5" jdbcType="INTEGER" />
  </resultMap>
  <resultMap id="DiagramListResult" type="com.sinopec.smcc.cpro.home.entity.DiagramListResult">
    <result column="level1" property="level1" jdbcType="INTEGER" />
    <result column="level2" property="level2" jdbcType="INTEGER" />
    <result column="level3" property="level3" jdbcType="INTEGER" />
    <result column="level4" property="level4" jdbcType="INTEGER" />
    <result column="level5" property="level5" jdbcType="INTEGER" />
    <result column="level" property="level" jdbcType="INTEGER" />
    <result column="companyName" property="companyName" jdbcType="VARCHAR" />
  </resultMap>
  <resultMap id="DiagramTrendResult" type="com.sinopec.smcc.cpro.home.entity.DiagramTrendResult">
    <result column="month" property="month" jdbcType="VARCHAR" />
    <result column="exceptGradCount" property="exceptGradCount" jdbcType="INTEGER" />
    <result column="checkGradCount" property="checkGradCount" jdbcType="INTEGER" />
    <result column="recordsCount" property="recordsCount" jdbcType="INTEGER" />
    <result column="evaluationCount" property="evaluationCount" jdbcType="INTEGER" />
    <result column="selfInspectionCount" property="selfInspectionCount" jdbcType="INTEGER" />
  </resultMap>

	<!-- 系统等保等级分布 -->
	<select id="selectSystemLevelProtectionDistribution" parameterType="com.sinopec.smcc.cpro.home.entity.DiagramParam"
	  resultMap="DiagramResult">
		<![CDATA[
			SELECT
				SUM(IF (sce.fkSpRanklevel = 301, 1, 0)) AS Level1,
				SUM(IF (sce.fkSpRanklevel = 302, 1, 0)) AS Level2,
				SUM(IF (sce.fkSpRanklevel = 303, 1, 0)) AS Level3,
				SUM(IF (sce.fkSpRanklevel = 304, 1, 0)) AS Level4,
				SUM(IF (sce.fkSpRanklevel = 305, 1, 0)) AS Level5
			FROM
				t_cpro_system sys
			LEFT JOIN t_cpro_score sce ON sce.fkSystemId = sys.pkId
		]]>
		<where>
			<![CDATA[
				sys.pkId IN (SELECT DISTINCT fkSystemId FROM t_cpro_score) AND sys.deleteStatus = 1 AND sce.deleteStatus = 1
      ]]>
			<choose>
				<when test="systemType == 1">
					<![CDATA[
		        AND sys.fkSystemType < 3
		      ]]>
				</when>
				<when test="systemType == 2">
					<![CDATA[
		        AND sys.fkSystemType = 3
		      ]]>
				</when>
				<otherwise>
					<![CDATA[
		        AND sys.fkSystemType = 0
		      ]]>
				</otherwise>
			</choose>
			<if test="dateBegin != null">
				<![CDATA[
	        AND sce.rankTime >= #{dateBegin}
	      ]]>
			</if>
			<if test="dateEnd != null">
				<![CDATA[
	        AND sce.rankTime <= #{dateEnd}
	      ]]>
			</if>
		</where>
	</select>
	<!-- 不同等保级别系统在不同等保管理状态下详情 -->
	<select id="selectSystemLevelBySystemType" parameterType="com.sinopec.smcc.cpro.home.entity.DiagramParam"
	  resultMap="DiagramResult">
		<![CDATA[
			SELECT
				SUM(IF (sce.fkSpRanklevel = 301, 1, 0)) AS Level1,
				SUM(IF (sce.fkSpRanklevel = 302, 1, 0)) AS Level2,
				SUM(IF (sce.fkSpRanklevel = 303, 1, 0)) AS Level3,
				SUM(IF (sce.fkSpRanklevel = 304, 1, 0)) AS Level4,
				SUM(IF (sce.fkSpRanklevel = 305, 1, 0)) AS Level5
			FROM
				t_cpro_system sys
			LEFT JOIN t_cpro_score sce ON sce.fkSystemId = sys.pkId
		]]>
		<where>
			<choose>
				<when test="systemType == 1">
					<![CDATA[
		        AND sys.fkSystemType < 3
		      ]]>
				</when>
				<when test="systemType == 2">
					<![CDATA[
		        AND sys.fkSystemType = 3
		      ]]>
				</when>
				<otherwise>
					<![CDATA[
		        AND sys.fkSystemType = 0
		      ]]>
				</otherwise>
			</choose>
			<if test="dateBegin != null">
				<![CDATA[
	        AND sce.rankTime >= #{dateBegin}
	      ]]>
			</if>
			<if test="dateEnd != null">
				<![CDATA[
	        AND sce.rankTime <= #{dateEnd}
	      ]]>
			</if>
			<if test="codeName == '完成测评数'">
				<![CDATA[
	        AND sys.evaluationStatus = 3
	      ]]>
			</if>
			<if test="codeName == '完成自查数'">
				<![CDATA[
	        AND sys.examinationStatus = 3
	      ]]>
			</if>
			<if test="codeName == '定级备案数'">
				<![CDATA[
	        
	      ]]>
			</if>
			<if test="codeName == '未自查数'">
				<![CDATA[
	        AND sys.examinationStatus < 3
	      ]]>
			</if>
			<if test="codeName == '企业自建数'">
				<![CDATA[
	        AND sys.fkInfoSysTypeCon = 1
	      ]]>
			</if>
			<if test="codeName == '总部统建数'">
				<![CDATA[
	        AND sys.fkInfoSysTypeCon = 3
	      ]]>
			</if>
			<if test="codeName == '未测评数'">
				<![CDATA[
	        AND sys.evaluationStatus < 3
	      ]]>
			</if>
		</where>
	</select>
	<!-- 备案单位数量Top10 -->
	<select id="selectRecordCompanyTop10" parameterType="com.sinopec.smcc.cpro.home.entity.DiagramParam"
	  resultMap="DiagramListResult">
		<![CDATA[
			SELECT
				SUM(IF (sce.fkSpRanklevel = 301, 1, 0)) AS Level1,
				SUM(IF (sce.fkSpRanklevel = 302, 1, 0)) AS Level2,
				SUM(IF (sce.fkSpRanklevel = 303, 1, 0)) AS Level3,
				SUM(IF (sce.fkSpRanklevel = 304, 1, 0)) AS Level4,
				SUM(IF (sce.fkSpRanklevel = 305, 1, 0)) AS Level5,
				SUM(IF (sce.fkSpRanklevel = 301 or 
                sce.fkSpRanklevel = 302 or 
                sce.fkSpRanklevel = 303 or 
                sce.fkSpRanklevel = 304 or
                sce.fkSpRanklevel = 305, 1, 0)) AS Level,
				rec.recordCompany  AS companyName
			FROM
				t_cpro_records rec
      LEFT JOIN t_cpro_system system 
        ON rec.fkSystemId = system.pkId
        AND system.deleteStatus = 1
      LEFT JOIN t_cpro_system system1 
        ON rec.fkSystemId = system1.fkFatherSystemId
        AND system1.deleteStatus = 1
      LEFT JOIN t_cpro_score sce 
        ON sce.fkSystemId = system.pkId
      LEFT JOIN t_cpro_company company 
        ON company.companyCode = system.fkCompanyCode
      LEFT JOIN t_cpro_check AS examine 
        ON system.pkId = examine.fkSystemId
      LEFT JOIN t_cpro_evaluation AS evaluation 
        ON system.pkId = evaluation.fkSystemId
        AND evaluation.deleteStatus = 1
        AND evaluation.createTime = (SELECT  MAX(eval.createTime) FROM t_cpro_evaluation eval 
                                     WHERE eval.fkSystemId = system.pkId AND eval.deleteStatus = 1 LIMIT 1)
      LEFT JOIN t_cpro_self_inspection AS selfInspection 
        ON system.pkId = selfInspection.fkSystemId
        AND selfInspection.deleteStatus = 1
        AND selfInspection.createTime = (SELECT  MAX(inspec.createTime) FROM t_cpro_self_inspection inspec 
                                         WHERE inspec.fkSystemId =  system.pkId AND inspec.deleteStatus = 1 LIMIT 1)
      LEFT JOIN t_cpro_system_code AS systemCodeSprankLevel 
        ON sce.fkSprankLevel = systemCodeSprankLevel.systemCode 
        AND systemCodeSprankLevel.fkCodeType = 11
      LEFT JOIN t_cpro_system_code AS systemCodeInfoSysTypeConstruction 
        ON system.fkInfoSysTypeCon = systemCodeInfoSysTypeConstruction.systemCode 
        AND systemCodeInfoSysTypeConstruction.fkCodeType = 7
      LEFT JOIN t_cpro_system_code AS gradingSystemCode 
        ON system.gradingStatus = gradingSystemCode.systemCode
        AND gradingSystemCode.fkCodeType = 25
      LEFT JOIN t_cpro_system_code AS examineSystemCode 
        ON system.examineStatus = examineSystemCode.systemCode
        AND examineSystemCode.fkCodeType = 25
      LEFT JOIN t_cpro_system_code AS recordSystemCode 
        ON system.recordStatus = recordSystemCode.systemCode
        AND recordSystemCode.fkCodeType = 25
      LEFT JOIN t_cpro_system_code AS evaluationSystemCode 
        ON system.evaluationStatus = evaluationSystemCode.systemCode
        AND evaluationSystemCode.fkCodeType = 25
      LEFT JOIN t_cpro_system_code AS examinationSystemCode 
        ON system.examinationStatus = examinationSystemCode.systemCode
        AND examinationSystemCode.fkCodeType = 25
      LEFT JOIN t_cpro_node node ON system.pkId = node.fkSystemId
        AND node.operation = '创建'
		]]>
		<where>
		  system.deleteStatus = 1 
		  AND rec.deleteStatus = 1 
		  AND system.examineStatus != 5 
		  AND system.recordStatus = 3 
		  AND system.gradingStatus!=4
		  AND system.evaluationStatus!=4
		  AND system.examinationStatus!=4
		  <if test="companyList != null">
        <![CDATA[
          AND company.companyCode IN  
        ]]>
        <foreach collection="companyList" item="item" index="index" open="(" separator="," close=")">
          <![CDATA[
            #{item}
          ]]>
        </foreach>
      </if>
      <if test="plateList != null">
        <![CDATA[
          AND company.fkPlateType IN  
        ]]>
        <foreach collection="plateList" item="item" index="index" open="(" separator="," close=")">
          <![CDATA[
            #{item}
          ]]>
        </foreach>
      </if>
			<if test="systemType != null and systemType == 1">
        <![CDATA[
           AND system.fkSystemType < 3
					AND (
						(
							system1.pkId IS NULL
							OR system1.fkFatherSystemId = ''
						)
						OR (
							system1.pkId IS NOT NULL
							AND system1.fkFatherSystemId != ''
							AND system1.pkId IN (
								SELECT
									MAX(system2.pkId)
								FROM
									t_cpro_system system2
								WHERE
									system.pkId = system2.fkFatherSystemId
								AND system2.fkSystemType = 3
								AND system2.deleteStatus = 1
							)
						)
					)
        ]]>
      </if>
      <if test="systemType != null and systemType == 2">
        <![CDATA[
           AND system1.fkSystemType = 3
    			AND system1.pkId IS NOT NULL 
    			AND system1.fkFatherSystemId != ''
        ]]>
      </if>
			<if test="dateBegin != null">
				<![CDATA[
	        AND rec.recordDate >= #{dateBegin}
	      ]]>
			</if>
			<if test="dateEnd != null">
				<![CDATA[
	        AND rec.recordDate <= #{dateEnd}
	      ]]>
			</if>
			<!-- 连动查询条件 -->
      <if test="systemName != null and systemName != ''">
      	<bind name="systemName" value="'%' + _parameter.systemName + '%'" />
        <![CDATA[
          AND system.systemName LIKE #{systemName}
        ]]>
      </if>
      <if test="appIsInternet != null">
      	<![CDATA[
          AND system.appIsInternet = #{appIsInternet}
        ]]>
      </if>
      <if test="companyName and companyName != ''">
        <bind name="companyName" value="'%' + _parameter.companyName + '%'" />
        <![CDATA[
          AND company.companyName LIKE #{companyName}
        ]]>
      </if>
      <if test="auditTimeBegin != null ">
        <![CDATA[
          AND node.createTime >= #{auditTimeBegin}
        ]]>
      </if>
      <if test="auditTimeEnd != null ">
        <![CDATA[
          AND node.createTime <= #{auditTimeEnd}
        ]]>
      </if>
      <if test="acceptCompany != null and acceptCompany != ''">
        <bind name="acceptCompany" value="'%' + _parameter.acceptCompany + '%'" />
        <![CDATA[
          AND rec.acceptCompany LIKE #{acceptCompany}
        ]]>
      </if>
      <if test="examOrg != null and examOrg != ''">
        <bind name="examOrg" value="'%' + _parameter.examOrg + '%'" />
        <![CDATA[
          AND evaluation.examOrg LIKE #{examOrg}
        ]]>
      </if>
      <if test="recordDateBegin != null ">
        <![CDATA[
          AND rec.recordDate >= #{recordDateBegin}
        ]]>
      </if>
      <if test="recordDateEnd != null ">
        <![CDATA[
          AND rec.recordDate <= #{recordDateEnd}
        ]]>
      </if>
      <if test="examTimeBegin != null ">
        <![CDATA[
          AND evaluation.examTime >= #{examTimeBegin}
        ]]>
      </if>
      <if test="examTimeEnd != null ">
        <![CDATA[
          AND evaluation.examTime <= #{examTimeEnd}
        ]]>
      </if>
      <if test="rankTimeBegin != null ">
        <![CDATA[
          AND sce.rankTime >= #{rankTimeBegin}
        ]]>
      </if>
      <if test="rankTimeEnd != null ">
        <![CDATA[
          AND sce.rankTime <= #{rankTimeEnd}
        ]]>
      </if>
      <if test="inspectionDateBegin != null ">
        <![CDATA[
          AND selfInspection.inspectionDate >= #{inspectionDateBegin}
        ]]>
      </if>
      <if test="inspectionDateEnd != null ">
        <![CDATA[
          AND selfInspection.inspectionDate <= #{inspectionDateEnd}
        ]]>
      </if>
      <if test="plTypeArray != null and plTypeArray.length > 0">
        <![CDATA[
          AND company.fkPlateType IN  
        ]]>
        <foreach collection="plTypeArray" item="item" index="index" open="(" separator="," close=")">
          <![CDATA[
            #{item}
          ]]>
        </foreach>
      </if>
      <if test="sprankLevelArray != null and sprankLevelArray.length > 0">
        <![CDATA[
          AND sce.fkSprankLevel IN  
        ]]>
        <foreach collection="sprankLevelArray" item="item" index="index" open="(" separator="," close=")">
          <![CDATA[
            #{item}
          ]]>
        </foreach>
      </if>
      <if test="subordinateProvincesArray != null and subordinateProvincesArray.length > 0">
        <![CDATA[
          AND company.fkSubordinatePro IN  
        ]]>
        <foreach collection="subordinateProvincesArray" item="item" index="index" open="(" separator="," close=")">
          <![CDATA[
            #{item}
          ]]>
        </foreach>
      </if>
      <if test="customFiltering != null and customFiltering != ''">
        <bind name="customFiltering" value="'%' + _parameter.customFiltering + '%'" />
          <![CDATA[
             system.systemName LIKE #{customFiltering} 
             AND (system.deleteStatus=1 
				     AND system.fkSystemType != 3
				     AND fkSystemIsMerge = 2)
             OR company.companyName LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR company.fkPlateType LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR systemCodeSprankLevel.codeName LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.appIsInternet LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR systemCodeInfoSysTypeConstruction.codeName LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR examine.fkExaminStatus LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.standardizedCode LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.gradeRecordSysName LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.sysBusSituationType LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.sysBusDescription LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.sysServiceSitScope LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.sysServiceSitObject LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.npCoverageRange LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.npNetworkProperties LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.executiveOfficeName LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.executiveDireCon LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.executiveDireConTel LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.changeReason LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.changeContent LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR gradingSystemCode.codeName LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR examineSystemCode.codeName LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR recordSystemCode.codeName LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR evaluationSystemCode.codeName LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR examinationSystemCode.codeName LIKE #{customFiltering}  
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR systemCodeAppIsInternet.codeName LIKE #{customFiltering} 
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
          ]]>
      </if>
      <!-- 定级状态 -->
      <if test="systemCodeType != null and systemCodeType == '23'">
        <![CDATA[
          AND system.gradingStatus = #{gradingStatus}
        ]]>
      </if>
      <!-- 审核状态  待审核-->
	    <if test="fkExaminStatus != null and fkExaminStatus == 1">
	        <![CDATA[
	          AND examine.fkExaminStatus = 1 
	        ]]>
	    </if>
	    <if test="fkExaminStatus != null and fkExaminStatus == 2">
	        <![CDATA[
	          AND examine.fkExaminStatus = 2 
	        ]]>
	    </if>
	    <!-- 审核状态 已审核-->
      <if test="fkExaminStatus != null and fkExaminStatus == 5">
          <![CDATA[
            AND examine.fkExaminStatus = 5
          ]]>
      </if>
      <!-- 审核状态 审核未通过-->
      <if test="fkExaminStatus != null and fkExaminStatus == 3">
          <![CDATA[
             AND examine.fkExaminStatus = 3 
          ]]>
      </if>
      <if test="fkExaminStatus != null and fkExaminStatus == 4">
          <![CDATA[
             AND examine.fkExaminStatus = 4 
          ]]>
      </if>
      <!-- 备案状态 -->
      <if test="systemCodeType != null and systemCodeType == '25'">
        <![CDATA[
          AND system.recordStatus = #{recordStatus}
        ]]>
      </if>
      <!-- 测评状态 -->
      <if test="systemCodeType != null and systemCodeType == '26'">
        <![CDATA[
          AND system.evaluationStatus = #{evaluationStatus}
        ]]>
      </if>
      <!-- 自查状态 -->
      <if test="systemCodeType != null and systemCodeType == '27'">
        <![CDATA[
          AND system.examinationStatus = #{examinationStatus}
        ]]>
      </if>
      
      <if test="gradingStatus1 !=null and gradingStatusType == '23'">
        <![CDATA[
          AND system.gradingStatus IN  
        ]]>
        <foreach collection="gradingStatus1" item="item" index="index" open="(" separator="," close=")">
          <![CDATA[
            #{item}
          ]]>
        </foreach>								
      </if>
      <if test="fkExaminStatus1 !=null and fkExaminStatusType == '24'">
        <![CDATA[
          AND system.examineStatus IN  
        ]]>
        <foreach collection="fkExaminStatus1" item="item" index="index" open="(" separator="," close=")">
          <![CDATA[
            #{item}
          ]]>
        </foreach>								
      </if>
      <if test="recordStatus1 !=null and recordStatusType == '25'">
        <![CDATA[
          AND system.recordStatus IN  
        ]]>
        <foreach collection="recordStatus1" item="item" index="index" open="(" separator="," close=")">
          <![CDATA[
            #{item}
          ]]>
        </foreach>								
      </if> 
      <if test="evaluationStatus1 !=null and evaluationStatusType == '26'">
          <![CDATA[
          AND system.evaluationStatus IN  
        ]]>
        <foreach collection="evaluationStatus1" item="item" index="index" open="(" separator="," close=")">
          <![CDATA[
            #{item}
          ]]>
        </foreach>								
      </if>
      <if test="examinationStatus1 !=null and examinationStatusType == '27'">
        <![CDATA[
          AND system.examinationStatus IN  
        ]]>
        <foreach collection="examinationStatus1" item="item" index="index" open="(" separator="," close=")">
          <![CDATA[
            #{item}
          ]]>
        </foreach>								
      </if>
      <if test="examinStatus1 !=null and examinStatusType == '28'">
        <![CDATA[
          AND system.examineStatus IN  
        ]]>
        <foreach collection="examinStatus1" item="item" index="index" open="(" separator="," close=")">
          <![CDATA[
            #{item}
          ]]>
        </foreach>								
      </if>
			
		</where>
		<![CDATA[
			GROUP BY rec.recordCompany
	    ORDER BY Level DESC
	    LIMIT 0,10
	  ]]>
	</select>
	<!-- 受理备案单位数量Top10 -->
	<select id="selectAcceptCompanyTop10" parameterType="com.sinopec.smcc.cpro.home.entity.DiagramParam"
	  resultMap="DiagramListResult">
		<![CDATA[
			SELECT
				SUM(IF (sce.fkSpRanklevel = 301, 1, 0)) AS Level1,
				SUM(IF (sce.fkSpRanklevel = 302, 1, 0)) AS Level2,
				SUM(IF (sce.fkSpRanklevel = 303, 1, 0)) AS Level3,
				SUM(IF (sce.fkSpRanklevel = 304, 1, 0)) AS Level4,
				SUM(IF (sce.fkSpRanklevel = 305, 1, 0)) AS Level5,
				SUM(IF (sce.fkSpRanklevel = 301 or 
				        sce.fkSpRanklevel = 302 or 
				        sce.fkSpRanklevel = 303 or 
				        sce.fkSpRanklevel = 304 or
				        sce.fkSpRanklevel = 305, 1, 0)) AS Level,
				rec.acceptCompany AS companyName
			FROM
				t_cpro_records rec
      LEFT JOIN t_cpro_system system 
        ON rec.fkSystemId = system.pkId
        AND system.deleteStatus = 1
      LEFT JOIN t_cpro_system system1 
        ON rec.fkSystemId = system1.fkFatherSystemId
        AND system1.deleteStatus = 1
      LEFT JOIN t_cpro_score sce 
        ON sce.fkSystemId = system.pkId
      LEFT JOIN t_cpro_company company 
        ON company.companyCode = system.fkCompanyCode
      LEFT JOIN t_cpro_check AS examine 
        ON system.pkId = examine.fkSystemId
      LEFT JOIN t_cpro_evaluation AS evaluation 
        ON system.pkId = evaluation.fkSystemId
        AND evaluation.deleteStatus = 1
        AND evaluation.createTime = (SELECT  MAX(eval.createTime) FROM t_cpro_evaluation eval 
                                     WHERE eval.fkSystemId = system.pkId AND eval.deleteStatus = 1 LIMIT 1)
      LEFT JOIN t_cpro_self_inspection AS selfInspection 
        ON system.pkId = selfInspection.fkSystemId
        AND selfInspection.deleteStatus = 1
        AND selfInspection.createTime = (SELECT  MAX(inspec.createTime) FROM t_cpro_self_inspection inspec 
                                         WHERE inspec.fkSystemId =  system.pkId AND inspec.deleteStatus = 1 LIMIT 1)
      LEFT JOIN t_cpro_system_code AS systemCodeSprankLevel 
        ON sce.fkSprankLevel = systemCodeSprankLevel.systemCode 
        AND systemCodeSprankLevel.fkCodeType = 11
      LEFT JOIN t_cpro_system_code AS systemCodeInfoSysTypeConstruction 
        ON system.fkInfoSysTypeCon = systemCodeInfoSysTypeConstruction.systemCode 
        AND systemCodeInfoSysTypeConstruction.fkCodeType = 7
      LEFT JOIN t_cpro_system_code AS gradingSystemCode 
        ON system.gradingStatus = gradingSystemCode.systemCode
        AND gradingSystemCode.fkCodeType = 25
      LEFT JOIN t_cpro_system_code AS examineSystemCode 
        ON system.examineStatus = examineSystemCode.systemCode
        AND examineSystemCode.fkCodeType = 25
      LEFT JOIN t_cpro_system_code AS recordSystemCode 
        ON system.recordStatus = recordSystemCode.systemCode
        AND recordSystemCode.fkCodeType = 25
      LEFT JOIN t_cpro_system_code AS evaluationSystemCode 
        ON system.evaluationStatus = evaluationSystemCode.systemCode
        AND evaluationSystemCode.fkCodeType = 25
      LEFT JOIN t_cpro_system_code AS examinationSystemCode 
        ON system.examinationStatus = examinationSystemCode.systemCode
        AND examinationSystemCode.fkCodeType = 25
	    LEFT JOIN t_cpro_node node ON system.pkId = node.fkSystemId
	      AND node.operation = '创建'
		]]>
		<where>
		  system.deleteStatus = 1 
		  AND rec.deleteStatus = 1 
		  AND system.examineStatus != 5 
		  AND system.recordStatus = 3 
		  AND system.gradingStatus!=4
		  AND system.evaluationStatus!=4
		  AND system.examinationStatus!=4
		  <if test="companyList != null">
        <![CDATA[
          AND company.companyCode IN  
        ]]>
        <foreach collection="companyList" item="item" index="index" open="(" separator="," close=")">
          <![CDATA[
            #{item}
          ]]>
        </foreach>
      </if>
      <if test="plateList != null">
        <![CDATA[
          AND company.fkPlateType IN  
        ]]>
        <foreach collection="plateList" item="item" index="index" open="(" separator="," close=")">
          <![CDATA[
            #{item}
          ]]>
        </foreach>
      </if>
			<if test="systemType != null and systemType == 1">
        <![CDATA[
           AND system.fkSystemType < 3
					AND (
						(
							system1.pkId IS NULL
							OR system1.fkFatherSystemId = ''
						)
						OR (
							system1.pkId IS NOT NULL
							AND system1.fkFatherSystemId != ''
							AND system1.pkId IN (
								SELECT
									MAX(system2.pkId)
								FROM
									t_cpro_system system2
								WHERE
									system.pkId = system2.fkFatherSystemId
								AND system2.fkSystemType = 3
								AND system2.deleteStatus = 1
							)
						)
					)
        ]]>
      </if>
      <if test="systemType != null and systemType == 2">
        <![CDATA[
           AND system1.fkSystemType = 3
    			AND system1.pkId IS NOT NULL 
    			AND system1.fkFatherSystemId != ''
        ]]>
      </if>
			<if test="dateBegin != null">
				<![CDATA[
	        AND rec.acceptDate >= #{dateBegin}
	      ]]>
			</if>
			<if test="dateEnd != null">
				<![CDATA[
	        AND rec.acceptDate <= #{dateEnd}
	      ]]>
			</if>
			
			<!-- 连动查询条件 -->
      <if test="systemName != null and systemName != ''">
      	<bind name="systemName" value="'%' + _parameter.systemName + '%'" />
        <![CDATA[
          AND system.systemName LIKE #{systemName}
        ]]>
      </if>
      <if test="appIsInternet != null">
      	<![CDATA[
          AND system.appIsInternet = #{appIsInternet}
        ]]>
      </if>
      <if test="companyName and companyName != ''">
        <bind name="companyName" value="'%' + _parameter.companyName + '%'" />
        <![CDATA[
          AND company.companyName LIKE #{companyName}
        ]]>
      </if>
      <if test="auditTimeBegin != null ">
        <![CDATA[
          AND node.createTime >= #{auditTimeBegin}
        ]]>
      </if>
      <if test="auditTimeEnd != null ">
        <![CDATA[
          AND node.createTime <= #{auditTimeEnd}
        ]]>
      </if>
      <if test="acceptCompany != null and acceptCompany != ''">
        <bind name="acceptCompany" value="'%' + _parameter.acceptCompany + '%'" />
        <![CDATA[
          AND rec.acceptCompany LIKE #{acceptCompany}
        ]]>
      </if>
      <if test="examOrg != null and examOrg != ''">
        <bind name="examOrg" value="'%' + _parameter.examOrg + '%'" />
        <![CDATA[
          AND evaluation.examOrg LIKE #{examOrg}
        ]]>
      </if>
      <if test="recordDateBegin != null ">
        <![CDATA[
          AND rec.recordDate >= #{recordDateBegin}
        ]]>
      </if>
      <if test="recordDateEnd != null ">
        <![CDATA[
          AND rec.recordDate <= #{recordDateEnd}
        ]]>
      </if>
      <if test="examTimeBegin != null ">
        <![CDATA[
          AND evaluation.examTime >= #{examTimeBegin}
        ]]>
      </if>
      <if test="examTimeEnd != null ">
        <![CDATA[
          AND evaluation.examTime <= #{examTimeEnd}
        ]]>
      </if>
      <if test="rankTimeBegin != null ">
        <![CDATA[
          AND sce.rankTime >= #{rankTimeBegin}
        ]]>
      </if>
      <if test="rankTimeEnd != null ">
        <![CDATA[
          AND sce.rankTime <= #{rankTimeEnd}
        ]]>
      </if>
      <if test="inspectionDateBegin != null ">
        <![CDATA[
          AND selfInspection.inspectionDate >= #{inspectionDateBegin}
        ]]>
      </if>
      <if test="inspectionDateEnd != null ">
        <![CDATA[
          AND selfInspection.inspectionDate <= #{inspectionDateEnd}
        ]]>
      </if>
      <if test="plTypeArray != null and plTypeArray.length > 0">
        <![CDATA[
          AND company.fkPlateType IN  
        ]]>
        <foreach collection="plTypeArray" item="item" index="index" open="(" separator="," close=")">
          <![CDATA[
            #{item}
          ]]>
        </foreach>
      </if>
      <if test="sprankLevelArray != null and sprankLevelArray.length > 0">
        <![CDATA[
          AND sce.fkSprankLevel IN  
        ]]>
        <foreach collection="sprankLevelArray" item="item" index="index" open="(" separator="," close=")">
          <![CDATA[
            #{item}
          ]]>
        </foreach>
      </if>
      <if test="subordinateProvincesArray != null and subordinateProvincesArray.length > 0">
        <![CDATA[
          AND company.fkSubordinatePro IN  
        ]]>
        <foreach collection="subordinateProvincesArray" item="item" index="index" open="(" separator="," close=")">
          <![CDATA[
            #{item}
          ]]>
        </foreach>
      </if>
      <if test="customFiltering != null and customFiltering != ''">
        <bind name="customFiltering" value="'%' + _parameter.customFiltering + '%'" />
          <![CDATA[
             system.systemName LIKE #{customFiltering} 
             AND (system.deleteStatus=1 
				     AND system.fkSystemType != 3
				     AND fkSystemIsMerge = 2)
             OR company.companyName LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR company.fkPlateType LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR systemCodeSprankLevel.codeName LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.appIsInternet LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR systemCodeInfoSysTypeConstruction.codeName LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR examine.fkExaminStatus LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.standardizedCode LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.gradeRecordSysName LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.sysBusSituationType LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.sysBusDescription LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.sysServiceSitScope LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.sysServiceSitObject LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.npCoverageRange LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.npNetworkProperties LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.executiveOfficeName LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.executiveDireCon LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.executiveDireConTel LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.changeReason LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.changeContent LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR gradingSystemCode.codeName LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR examineSystemCode.codeName LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR recordSystemCode.codeName LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR evaluationSystemCode.codeName LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR examinationSystemCode.codeName LIKE #{customFiltering}  
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR systemCodeAppIsInternet.codeName LIKE #{customFiltering} 
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
          ]]>
      </if>
      <!-- 定级状态 -->
      <if test="systemCodeType != null and systemCodeType == '23'">
        <![CDATA[
          AND system.gradingStatus = #{gradingStatus}
        ]]>
      </if>
      <!-- 审核状态  待审核-->
	    <if test="fkExaminStatus != null and fkExaminStatus == 1">
	        <![CDATA[
	          AND examine.fkExaminStatus = 1 
	        ]]>
	    </if>
	    <if test="fkExaminStatus != null and fkExaminStatus == 2">
	        <![CDATA[
	          AND examine.fkExaminStatus = 2 
	        ]]>
	    </if>
	    <!-- 审核状态 已审核-->
      <if test="fkExaminStatus != null and fkExaminStatus == 5">
          <![CDATA[
            AND examine.fkExaminStatus = 5
          ]]>
      </if>
      <!-- 审核状态 审核未通过-->
      <if test="fkExaminStatus != null and fkExaminStatus == 3">
          <![CDATA[
             AND examine.fkExaminStatus = 3 
          ]]>
      </if>
      <if test="fkExaminStatus != null and fkExaminStatus == 4">
          <![CDATA[
             AND examine.fkExaminStatus = 4 
          ]]>
      </if>
      <!-- 备案状态 -->
      <if test="systemCodeType != null and systemCodeType == '25'">
        <![CDATA[
          AND system.recordStatus = #{recordStatus}
        ]]>
      </if>
      <!-- 测评状态 -->
      <if test="systemCodeType != null and systemCodeType == '26'">
        <![CDATA[
          AND system.evaluationStatus = #{evaluationStatus}
        ]]>
      </if>
      <!-- 自查状态 -->
      <if test="systemCodeType != null and systemCodeType == '27'">
        <![CDATA[
          AND system.examinationStatus = #{examinationStatus}
        ]]>
      </if>
      
      <if test="gradingStatus1 !=null and gradingStatusType == '23'">
        <![CDATA[
          AND system.gradingStatus IN  
        ]]>
        <foreach collection="gradingStatus1" item="item" index="index" open="(" separator="," close=")">
          <![CDATA[
            #{item}
          ]]>
        </foreach>								
      </if>
      <if test="fkExaminStatus1 !=null and fkExaminStatusType == '24'">
        <![CDATA[
          AND system.examineStatus IN  
        ]]>
        <foreach collection="fkExaminStatus1" item="item" index="index" open="(" separator="," close=")">
          <![CDATA[
            #{item}
          ]]>
        </foreach>								
      </if>
      <if test="recordStatus1 !=null and recordStatusType == '25'">
        <![CDATA[
          AND system.recordStatus IN  
        ]]>
        <foreach collection="recordStatus1" item="item" index="index" open="(" separator="," close=")">
          <![CDATA[
            #{item}
          ]]>
        </foreach>								
      </if> 
      <if test="evaluationStatus1 !=null and evaluationStatusType == '26'">
          <![CDATA[
          AND system.evaluationStatus IN  
        ]]>
        <foreach collection="evaluationStatus1" item="item" index="index" open="(" separator="," close=")">
          <![CDATA[
            #{item}
          ]]>
        </foreach>								
      </if>
      <if test="examinationStatus1 !=null and examinationStatusType == '27'">
        <![CDATA[
          AND system.examinationStatus IN  
        ]]>
        <foreach collection="examinationStatus1" item="item" index="index" open="(" separator="," close=")">
          <![CDATA[
            #{item}
          ]]>
        </foreach>								
      </if>
      <if test="examinStatus1 !=null and examinStatusType == '28'">
        <![CDATA[
          AND system.examineStatus IN  
        ]]>
        <foreach collection="examinStatus1" item="item" index="index" open="(" separator="," close=")">
          <![CDATA[
            #{item}
          ]]>
        </foreach>								
      </if>
      
		</where>
		<![CDATA[
			GROUP BY rec.acceptCompany
	    ORDER BY Level DESC
	    LIMIT 0,10
	  ]]>
	</select>
	<!-- 系统等保管理阶段趋势 -->
	<select id="selectSystemTrendByYear" parameterType="com.sinopec.smcc.cpro.home.entity.DiagramParam" resultMap="DiagramListResult">
		SELECT 
			MONTH( system.createTime ) AS mouthCount,
			SUM( IF ( system.gradingStatus = 3, 1, 0 ) ) AS readyGradCount,
			SUM( IF ( system.examineStatus = 3, 1, 0 ) ) AS checkGradCount,
			SUM( IF ( system.recordStatus = 3, 1, 0 ) ) AS recordsCount,
			SUM( IF ( system.evaluationStatus = 3, 1, 0 ) ) AS evaluationCount,
			SUM( IF ( system.examinationStatus = 3, 1, 0 ) ) AS selfInspectionCount,
			(
			CASE
				MONTH ( system.createTime ) 
				WHEN 1 THEN
				'一月' 
				WHEN 2 THEN
				'二月' 
				WHEN 3 THEN
				'三月' 
				WHEN 4 THEN
				'四月' 
				WHEN 5 THEN
				'五月' 
				WHEN 6 THEN
				'六月' 
				WHEN 7 THEN
				'七月' 
				WHEN 8 THEN
				'八月' 
				WHEN 9 THEN
				'九月' 
				WHEN 10 THEN
				'十月' 
				WHEN 11 THEN
				'十一月' ELSE '十二月' 
			END 
			) AS MONTH
		FROM
			t_cpro_system AS system
			LEFT JOIN t_cpro_system AS system1 ON system.pkId = system1.fkFatherSystemId AND system1.deleteStatus = 1
			LEFT JOIN t_cpro_company AS company ON system.fkCompanyCode = company.companyCode
			LEFT JOIN t_cpro_system_code AS systemCodeAppIsInternet ON system.appIsInternet = systemCodeAppIsInternet.systemCode 
			AND systemCodeAppIsInternet.fkCodeType = 10
			LEFT JOIN t_cpro_system_code AS systemCodeInfoSysTypeConstruction ON system.fkInfoSysTypeCon = systemCodeInfoSysTypeConstruction.systemCode 
			AND systemCodeInfoSysTypeConstruction.fkCodeType = 7
			LEFT JOIN t_cpro_score AS score ON system.pkid = score.fkSystemId 
			AND score.deleteStatus = 1
			LEFT JOIN t_cpro_system_code AS systemCodeSprankLevel ON score.fkSprankLevel = systemCodeSprankLevel.systemCode 
			AND systemCodeSprankLevel.fkCodeType = 11
			LEFT JOIN t_cpro_records AS records ON system.pkId = records.fkSystemId
			LEFT JOIN t_cpro_evaluation AS evaluation ON system.pkId = evaluation.fkSystemId 
			AND evaluation.createTime = (
			SELECT
				MAX( eval.createTime ) 
			FROM
				t_cpro_evaluation eval 
			WHERE
				eval.fkSystemId = system.pkId 
				AND eval.deleteStatus = 1 
				LIMIT 1 
			)
			LEFT JOIN t_cpro_self_inspection AS selfInspection ON system.pkId = selfInspection.fkSystemId 
			AND selfInspection.createTime = (
			SELECT
				MAX( inspec.createTime ) 
			FROM
				t_cpro_self_inspection inspec 
			WHERE
				inspec.fkSystemId = system.pkId 
				AND inspec.deleteStatus = 1 
				LIMIT 1 
			)
			LEFT JOIN t_cpro_check AS examine ON system.pkId = examine.fkSystemId
			LEFT JOIN t_cpro_attach AS gradingAttch ON score.fkSystemId = gradingAttch.fkSystemId 
			AND score.pkId = gradingAttch.fkSyssonId 
			AND gradingAttch.fkAttachType = 'gradingReport'
			LEFT JOIN t_cpro_attach AS checkAttch ON score.fkSystemId = checkAttch.fkSystemId 
			AND score.pkId = checkAttch.fkSyssonId 
			AND checkAttch.fkAttachType = 'expertReview'
			LEFT JOIN t_cpro_attach AS evaluationAttch ON evaluation.fkSystemId = evaluationAttch.fkSystemId 
			AND evaluation.pkId = evaluationAttch.fkSyssonId 
			AND evaluationAttch.fkAttachType = 'evaluationPresentation'
			LEFT JOIN t_cpro_attach AS selfAttch ON selfInspection.fkSystemId = selfAttch.fkSystemId 
			AND selfInspection.pkId = selfAttch.fkSyssonId 
			AND selfAttch.fkAttachType = 'examinationReport'
			LEFT JOIN t_cpro_system_code AS gradingSystemCode ON system.gradingStatus = gradingSystemCode.systemCode 
			AND gradingSystemCode.fkCodeType = 25
			LEFT JOIN t_cpro_system_code AS examineSystemCode ON system.examineStatus = examineSystemCode.systemCode 
			AND examineSystemCode.fkCodeType = 25
			LEFT JOIN t_cpro_system_code AS recordSystemCode ON system.recordStatus = recordSystemCode.systemCode 
			AND recordSystemCode.fkCodeType = 25
			LEFT JOIN t_cpro_system_code AS evaluationSystemCode ON system.evaluationStatus = evaluationSystemCode.systemCode 
			AND evaluationSystemCode.fkCodeType = 25
			LEFT JOIN t_cpro_system_code AS examinationSystemCode ON system.examinationStatus = examinationSystemCode.systemCode 
			AND examinationSystemCode.fkCodeType = 25 
    	LEFT JOIN t_cpro_node node ON system.pkId = node.fkSystemId
      AND node.operation = '创建'
		<where>
		  system.deleteStatus = 1 
		  AND system.createTime!=''
		  AND company.deleteStatus = 1 
		  AND system.examineStatus!=5
		  AND system.gradingStatus!=4
		  AND system.recordStatus!=4
		  AND system.evaluationStatus!=4
		  AND system.examinationStatus!=4
		<if test="companyList != null">
        <![CDATA[
          AND company.companyCode IN  
        ]]>
        <foreach collection="companyList" item="item" index="index" open="(" separator="," close=")">
          <![CDATA[
            #{item}
          ]]>
        </foreach>
      	</if>
      	<if test="plateList != null">
        <![CDATA[
          AND company.fkPlateType IN  
        ]]>
        <foreach collection="plateList" item="item" index="index" open="(" separator="," close=")">
          <![CDATA[
            #{item}
          ]]>
        </foreach>
      	</if>
	    <if test="systemType != null and systemType == 1">
        <![CDATA[
           AND system.fkSystemType < 3
					AND (
						(
							system1.pkId IS NULL
							OR system1.fkFatherSystemId = ''
						)
						OR (
							system1.pkId IS NOT NULL
							AND system1.fkFatherSystemId != ''
							AND system1.pkId IN (
								SELECT
									MAX(system2.pkId)
								FROM
									t_cpro_system system2
								WHERE
									system.pkId = system2.fkFatherSystemId
								AND system2.fkSystemType = 3
								AND system2.deleteStatus = 1
							)
						)
					)
        ]]>
      	</if>
      	<if test="systemType != null and systemType == 2">
        <![CDATA[
           AND system1.fkSystemType = 3
    			AND system1.pkId IS NOT NULL 
    			AND system1.fkFatherSystemId != ''
        ]]>
      	</if>
				<if test="year != null">
	        <![CDATA[
	          AND YEAR(system.createTime) = #{year}
	        ]]>
      	</if>
      	<!-- 连动查询条件 -->
      <if test="systemName != null and systemName != ''">
      	<bind name="systemName" value="'%' + _parameter.systemName + '%'" />
        <![CDATA[
          AND system.systemName LIKE #{systemName}
        ]]>
      </if>
      <if test="appIsInternet != null">
      	<![CDATA[
          AND system.appIsInternet = #{appIsInternet}
        ]]>
      </if>
      <if test="companyName and companyName != ''">
        <bind name="companyName" value="'%' + _parameter.companyName + '%'" />
        <![CDATA[
          AND company.companyName LIKE #{companyName}
        ]]>
      </if>
      <if test="auditTimeBegin != null ">
        <![CDATA[
          AND node.createTime >= #{auditTimeBegin}
        ]]>
      </if>
      <if test="auditTimeEnd != null ">
        <![CDATA[
          AND node.createTime <= #{auditTimeEnd}
        ]]>
      </if>
      <if test="acceptCompany != null and acceptCompany != ''">
        <bind name="acceptCompany" value="'%' + _parameter.acceptCompany + '%'" />
        <![CDATA[
          AND records.acceptCompany LIKE #{acceptCompany}
        ]]>
      </if>
      <if test="examOrg != null and examOrg != ''">
        <bind name="examOrg" value="'%' + _parameter.examOrg + '%'" />
        <![CDATA[
          AND evaluation.examOrg LIKE #{examOrg}
        ]]>
      </if>
      <if test="recordDateBegin != null ">
        <![CDATA[
          AND records.recordDate >= #{recordDateBegin}
        ]]>
      </if>
      <if test="recordDateEnd != null ">
        <![CDATA[
          AND records.recordDate <= #{recordDateEnd}
        ]]>
      </if>
      <if test="examTimeBegin != null ">
        <![CDATA[
          AND evaluation.examTime >= #{examTimeBegin}
        ]]>
      </if>
      <if test="examTimeEnd != null ">
        <![CDATA[
          AND evaluation.examTime <= #{examTimeEnd}
        ]]>
      </if>
      <if test="rankTimeBegin != null ">
        <![CDATA[
          AND score.rankTime >= #{rankTimeBegin}
        ]]>
      </if>
      <if test="rankTimeEnd != null ">
        <![CDATA[
          AND score.rankTime <= #{rankTimeEnd}
        ]]>
      </if>
      <if test="inspectionDateBegin != null ">
        <![CDATA[
          AND selfInspection.inspectionDate >= #{inspectionDateBegin}
        ]]>
      </if>
      <if test="inspectionDateEnd != null ">
        <![CDATA[
          AND selfInspection.inspectionDate <= #{inspectionDateEnd}
        ]]>
      </if>
      <if test="plTypeArray != null and plTypeArray.length > 0">
        <![CDATA[
          AND company.fkPlateType IN  
        ]]>
        <foreach collection="plTypeArray" item="item" index="index" open="(" separator="," close=")">
          <![CDATA[
            #{item}
          ]]>
        </foreach>
      </if>
      <if test="sprankLevelArray != null and sprankLevelArray.length > 0">
        <![CDATA[
          AND score.fkSprankLevel IN  
        ]]>
        <foreach collection="sprankLevelArray" item="item" index="index" open="(" separator="," close=")">
          <![CDATA[
            #{item}
          ]]>
        </foreach>
      </if>
      <if test="subordinateProvincesArray != null and subordinateProvincesArray.length > 0">
        <![CDATA[
          AND company.fkSubordinatePro IN  
        ]]>
        <foreach collection="subordinateProvincesArray" item="item" index="index" open="(" separator="," close=")">
          <![CDATA[
            #{item}
          ]]>
        </foreach>
      </if>
      <if test="customFiltering != null and customFiltering != ''">
        <bind name="customFiltering" value="'%' + _parameter.customFiltering + '%'" />
          <![CDATA[
             system.systemName LIKE #{customFiltering} 
             AND (system.deleteStatus=1 
				     AND system.fkSystemType != 3
				     AND fkSystemIsMerge = 2)
             OR company.companyName LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR company.fkPlateType LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR systemCodeSprankLevel.codeName LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.appIsInternet LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR systemCodeInfoSysTypeConstruction.codeName LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR examine.fkExaminStatus LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.standardizedCode LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.gradeRecordSysName LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.sysBusSituationType LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.sysBusDescription LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.sysServiceSitScope LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.sysServiceSitObject LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.npCoverageRange LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.npNetworkProperties LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.executiveOfficeName LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.executiveDireCon LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.executiveDireConTel LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.changeReason LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.changeContent LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR gradingSystemCode.codeName LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR examineSystemCode.codeName LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR recordSystemCode.codeName LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR evaluationSystemCode.codeName LIKE #{customFiltering}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR examinationSystemCode.codeName LIKE #{customFiltering}  
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR systemCodeAppIsInternet.codeName LIKE #{customFiltering} 
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
          ]]>
      </if>
      <!-- 定级状态 -->
      <if test="systemCodeType != null and systemCodeType == '23'">
        <![CDATA[
          AND system.gradingStatus = #{gradingStatus}
        ]]>
      </if>
      <!-- 审核状态  待审核-->
	    <if test="fkExaminStatus != null and fkExaminStatus == 1">
	        <![CDATA[
	          AND examine.fkExaminStatus = 1 
	        ]]>
	    </if>
	    <if test="fkExaminStatus != null and fkExaminStatus == 2">
	        <![CDATA[
	          AND examine.fkExaminStatus = 2 
	        ]]>
	    </if>
	    <!-- 审核状态 已审核-->
      <if test="fkExaminStatus != null and fkExaminStatus == 5">
          <![CDATA[
            AND examine.fkExaminStatus = 5
          ]]>
      </if>
      <!-- 审核状态 审核未通过-->
      <if test="fkExaminStatus != null and fkExaminStatus == 3">
          <![CDATA[
             AND examine.fkExaminStatus = 3 
          ]]>
      </if>
      <if test="fkExaminStatus != null and fkExaminStatus == 4">
          <![CDATA[
             AND examine.fkExaminStatus = 4 
          ]]>
      </if>
      <!-- 备案状态 -->
      <if test="systemCodeType != null and systemCodeType == '25'">
        <![CDATA[
          AND system.recordStatus = #{recordStatus}
        ]]>
      </if>
      <!-- 测评状态 -->
      <if test="systemCodeType != null and systemCodeType == '26'">
        <![CDATA[
          AND system.evaluationStatus = #{evaluationStatus}
        ]]>
      </if>
      <!-- 自查状态 -->
      <if test="systemCodeType != null and systemCodeType == '27'">
        <![CDATA[
          AND system.examinationStatus = #{examinationStatus}
        ]]>
      </if>
      
      <if test="gradingStatus1 !=null and gradingStatusType == '23'">
        <![CDATA[
          AND system.gradingStatus IN  
        ]]>
        <foreach collection="gradingStatus1" item="item" index="index" open="(" separator="," close=")">
          <![CDATA[
            #{item}
          ]]>
        </foreach>								
      </if>
      <if test="fkExaminStatus1 !=null and fkExaminStatusType == '24'">
        <![CDATA[
          AND system.examineStatus IN  
        ]]>
        <foreach collection="fkExaminStatus1" item="item" index="index" open="(" separator="," close=")">
          <![CDATA[
            #{item}
          ]]>
        </foreach>								
      </if>
      <if test="recordStatus1 !=null and recordStatusType == '25'">
        <![CDATA[
          AND system.recordStatus IN  
        ]]>
        <foreach collection="recordStatus1" item="item" index="index" open="(" separator="," close=")">
          <![CDATA[
            #{item}
          ]]>
        </foreach>								
      </if> 
      <if test="evaluationStatus1 !=null and evaluationStatusType == '26'">
          <![CDATA[
          AND system.evaluationStatus IN  
        ]]>
        <foreach collection="evaluationStatus1" item="item" index="index" open="(" separator="," close=")">
          <![CDATA[
            #{item}
          ]]>
        </foreach>								
      </if>
      <if test="examinationStatus1 !=null and examinationStatusType == '27'">
        <![CDATA[
          AND system.examinationStatus IN  
        ]]>
        <foreach collection="examinationStatus1" item="item" index="index" open="(" separator="," close=")">
          <![CDATA[
            #{item}
          ]]>
        </foreach>								
      </if>
      <if test="examinStatus1 !=null and examinStatusType == '28'">
        <![CDATA[
          AND system.examineStatus IN  
        ]]>
        <foreach collection="examinStatus1" item="item" index="index" open="(" separator="," close=")">
          <![CDATA[
            #{item}
          ]]>
        </foreach>								
      </if>
    </where>
		GROUP BY MONTH(system.createTime)
		<!-- HAVING readyGradCount!=0 AND checkGradCount!=0 AND recordsCount!=0 AND evaluationCount!=0 AND selfInspectionCount!=0 -->
	</select>
</mapper>