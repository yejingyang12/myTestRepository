<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sinopec.smcc.cpro.home.mapper.DiagramMapper">
  <resultMap id="DiagramResult" type="com.sinopec.smcc.cpro.home.entity.DiagramResult">
    <result column="level1" property="level1" jdbcType="INTEGER" />
    <result column="level2" property="level2" jdbcType="INTEGER" />
    <result column="level3" property="level3" jdbcType="INTEGER" />
    <result column="level4" property="level4" jdbcType="INTEGER" />
    <result column="level5" property="level5" jdbcType="INTEGER" />
  </resultMap>
  <resultMap id="DiagramListResult" type="com.sinopec.smcc.cpro.home.entity.DiagramListResult">
    <result column="level1" property="level1" jdbcType="INTEGER" />
    <result column="level2" property="level2" jdbcType="INTEGER" />
    <result column="level3" property="level3" jdbcType="INTEGER" />
    <result column="level4" property="level4" jdbcType="INTEGER" />
    <result column="level5" property="level5" jdbcType="INTEGER" />
    <result column="level" property="level" jdbcType="INTEGER" />
    <result column="companyName" property="companyName" jdbcType="VARCHAR" />
  </resultMap>
  <resultMap id="DiagramTrendResult" type="com.sinopec.smcc.cpro.home.entity.DiagramTrendResult">
    <result column="month" property="month" jdbcType="VARCHAR" />
    <result column="exceptGradCount" property="exceptGradCount" jdbcType="INTEGER" />
    <result column="checkGradCount" property="checkGradCount" jdbcType="INTEGER" />
    <result column="recordsCount" property="recordsCount" jdbcType="INTEGER" />
    <result column="evaluationCount" property="evaluationCount" jdbcType="INTEGER" />
    <result column="selfInspectionCount" property="selfInspectionCount" jdbcType="INTEGER" />
  </resultMap>

	<!-- 系统等保等级分布 -->
	<select id="selectSystemLevelProtectionDistribution" parameterType="com.sinopec.smcc.cpro.home.entity.DiagramParam"
	  resultMap="DiagramResult">
		<![CDATA[
			SELECT
				SUM(IF (sce.fkSpRanklevel = 301, 1, 0)) AS Level1,
				SUM(IF (sce.fkSpRanklevel = 302, 1, 0)) AS Level2,
				SUM(IF (sce.fkSpRanklevel = 303, 1, 0)) AS Level3,
				SUM(IF (sce.fkSpRanklevel = 304, 1, 0)) AS Level4,
				SUM(IF (sce.fkSpRanklevel = 305, 1, 0)) AS Level5
			FROM
				t_cpro_system sys
			LEFT JOIN t_cpro_score sce ON sce.fkSystemId = sys.pkId
		]]>
		<where>
			<![CDATA[
				sys.pkId IN (SELECT DISTINCT fkSystemId FROM t_cpro_score) AND sys.deleteStatus = 1 AND sce.deleteStatus = 1
      ]]>
			<choose>
				<when test="systemType == 1">
					<![CDATA[
		        AND sys.fkSystemType < 3
		      ]]>
				</when>
				<when test="systemType == 2">
					<![CDATA[
		        AND sys.fkSystemType = 3
		      ]]>
				</when>
				<otherwise>
					<![CDATA[
		        AND sys.fkSystemType = 0
		      ]]>
				</otherwise>
			</choose>
			<if test="dateBegin != null">
				<![CDATA[
	        AND sce.rankTime >= #{dateBegin}
	      ]]>
			</if>
			<if test="dateEnd != null">
				<![CDATA[
	        AND sce.rankTime <= #{dateEnd}
	      ]]>
			</if>
		</where>
	</select>
	<!-- 不同等保级别系统在不同等保管理状态下详情 -->
	<select id="selectSystemLevelBySystemType" parameterType="com.sinopec.smcc.cpro.home.entity.DiagramParam"
	  resultMap="DiagramResult">
		<![CDATA[
			SELECT
				SUM(IF (sce.fkSpRanklevel = 301, 1, 0)) AS Level1,
				SUM(IF (sce.fkSpRanklevel = 302, 1, 0)) AS Level2,
				SUM(IF (sce.fkSpRanklevel = 303, 1, 0)) AS Level3,
				SUM(IF (sce.fkSpRanklevel = 304, 1, 0)) AS Level4,
				SUM(IF (sce.fkSpRanklevel = 305, 1, 0)) AS Level5
			FROM
				t_cpro_system sys
			LEFT JOIN t_cpro_score sce ON sce.fkSystemId = sys.pkId
		]]>
		<where>
			<choose>
				<when test="systemType == 1">
					<![CDATA[
		        AND sys.fkSystemType < 3
		      ]]>
				</when>
				<when test="systemType == 2">
					<![CDATA[
		        AND sys.fkSystemType = 3
		      ]]>
				</when>
				<otherwise>
					<![CDATA[
		        AND sys.fkSystemType = 0
		      ]]>
				</otherwise>
			</choose>
			<if test="dateBegin != null">
				<![CDATA[
	        AND sce.rankTime >= #{dateBegin}
	      ]]>
			</if>
			<if test="dateEnd != null">
				<![CDATA[
	        AND sce.rankTime <= #{dateEnd}
	      ]]>
			</if>
			<if test="codeName == '完成测评数'">
				<![CDATA[
	        AND sys.evaluationStatus = 3
	      ]]>
			</if>
			<if test="codeName == '完成自查数'">
				<![CDATA[
	        AND sys.examinationStatus = 3
	      ]]>
			</if>
			<if test="codeName == '定级备案数'">
				<![CDATA[
	        
	      ]]>
			</if>
			<if test="codeName == '未自查数'">
				<![CDATA[
	        AND sys.examinationStatus < 3
	      ]]>
			</if>
			<if test="codeName == '企业自建数'">
				<![CDATA[
	        AND sys.fkInfoSysTypeCon = 1
	      ]]>
			</if>
			<if test="codeName == '总部统建数'">
				<![CDATA[
	        AND sys.fkInfoSysTypeCon = 3
	      ]]>
			</if>
			<if test="codeName == '未测评数'">
				<![CDATA[
	        AND sys.evaluationStatus < 3
	      ]]>
			</if>
		</where>
	</select>
	<!-- 备案单位数量Top10 -->
	<select id="selectRecordCompanyTop10" parameterType="com.sinopec.smcc.cpro.home.entity.DiagramParam"
	  resultMap="DiagramListResult">
		<![CDATA[
			SELECT
				SUM(IF (sce.fkSpRanklevel = 301, 1, 0)) AS Level1,
				SUM(IF (sce.fkSpRanklevel = 302, 1, 0)) AS Level2,
				SUM(IF (sce.fkSpRanklevel = 303, 1, 0)) AS Level3,
				SUM(IF (sce.fkSpRanklevel = 304, 1, 0)) AS Level4,
				SUM(IF (sce.fkSpRanklevel = 305, 1, 0)) AS Level5,
				SUM(IF (sce.fkSpRanklevel = 301 or 
                sce.fkSpRanklevel = 302 or 
                sce.fkSpRanklevel = 303 or 
                sce.fkSpRanklevel = 304 or
                sce.fkSpRanklevel = 305, 1, 0)) AS Level,
				rec.recordCompany  AS companyName
			FROM
				t_cpro_records rec
      LEFT JOIN t_cpro_system sys 
        ON rec.fkSystemId = sys.pkId
      LEFT JOIN t_cpro_score sce 
        ON sce.fkSystemId = sys.pkId
      LEFT JOIN t_cpro_company com 
        ON com.companyCode = sys.fkCompanyCode
		]]>
		<where>
		  rec.deleteStatus = 1
		  <if test="companyList != null">
        <![CDATA[
          AND com.companyCode IN  
        ]]>
        <foreach collection="companyList" item="item" index="index" open="(" separator="," close=")">
          <![CDATA[
            #{item}
          ]]>
        </foreach>
      </if>
      <if test="plateList != null">
        <![CDATA[
          AND com.fkPlateType IN  
        ]]>
        <foreach collection="plateList" item="item" index="index" open="(" separator="," close=")">
          <![CDATA[
            #{item}
          ]]>
        </foreach>
      </if>
			<if test="systemType != null and systemType == 1">
        <![CDATA[
           AND sys.fkSystemType < 3
        ]]>
      </if>
      <if test="systemType != null and systemType == 2">
        <![CDATA[
           AND sys.fkSystemType = 3
        ]]>
      </if>
			<if test="dateBegin != null">
				<![CDATA[
	        AND rec.recordDate >= #{dateBegin}
	      ]]>
			</if>
			<if test="dateEnd != null">
				<![CDATA[
	        AND rec.recordDate <= #{dateEnd}
	      ]]>
			</if>
		</where>
		<![CDATA[
			GROUP BY rec.recordCompany
	    ORDER BY Level DESC
	    LIMIT 0,10
	  ]]>
	</select>
	<!-- 受理备案单位数量Top10 -->
	<select id="selectAcceptCompanyTop10" parameterType="com.sinopec.smcc.cpro.home.entity.DiagramParam"
	  resultMap="DiagramListResult">
		<![CDATA[
			SELECT
				SUM(IF (sce.fkSpRanklevel = 301, 1, 0)) AS Level1,
				SUM(IF (sce.fkSpRanklevel = 302, 1, 0)) AS Level2,
				SUM(IF (sce.fkSpRanklevel = 303, 1, 0)) AS Level3,
				SUM(IF (sce.fkSpRanklevel = 304, 1, 0)) AS Level4,
				SUM(IF (sce.fkSpRanklevel = 305, 1, 0)) AS Level5,
				SUM(IF (sce.fkSpRanklevel = 301 or 
				        sce.fkSpRanklevel = 302 or 
				        sce.fkSpRanklevel = 303 or 
				        sce.fkSpRanklevel = 304 or
				        sce.fkSpRanklevel = 305, 1, 0)) AS Level,
				rec.acceptCompany AS companyName
			FROM
				t_cpro_records rec
      LEFT JOIN t_cpro_system sys 
        ON rec.fkSystemId = sys.pkId
      LEFT JOIN t_cpro_score sce 
        ON sce.fkSystemId = sys.pkId
      LEFT JOIN t_cpro_company com 
        ON com.companyCode = sys.fkCompanyCode
		]]>
		<where>
		  rec.deleteStatus = 1
		  <if test="companyList != null">
        <![CDATA[
          AND com.companyCode IN  
        ]]>
        <foreach collection="companyList" item="item" index="index" open="(" separator="," close=")">
          <![CDATA[
            #{item}
          ]]>
        </foreach>
      </if>
      <if test="plateList != null">
        <![CDATA[
          AND com.fkPlateType IN  
        ]]>
        <foreach collection="plateList" item="item" index="index" open="(" separator="," close=")">
          <![CDATA[
            #{item}
          ]]>
        </foreach>
      </if>
			<if test="systemType != null and systemType == 1">
        <![CDATA[
           AND sys.fkSystemType < 3
        ]]>
      </if>
      <if test="systemType != null and systemType == 2">
        <![CDATA[
           AND sys.fkSystemType = 3
        ]]>
      </if>
			<if test="dateBegin != null">
				<![CDATA[
	        AND rec.acceptDate >= #{dateBegin}
	      ]]>
			</if>
			<if test="dateEnd != null">
				<![CDATA[
	        AND rec.acceptDate <= #{dateEnd}
	      ]]>
			</if>
		</where>
		<![CDATA[
			GROUP BY rec.acceptCompany
	    ORDER BY Level DESC
	    LIMIT 0,10
	  ]]>
	</select>
	<!-- 系统等保管理阶段趋势 -->
	<select id="selectSystemTrendByYear" parameterType="com.sinopec.smcc.cpro.home.entity.DiagramParam" resultMap="DiagramListResult">
		SELECT 
			MONTH( system.createTime ) AS mouthCount,
			SUM( IF ( system.gradingStatus = 2, 1, 0 ) ) AS readyGradCount,
			SUM( IF ( system.examineStatus = 3, 1, 0 ) ) AS checkGradCount,
			SUM( IF ( system.recordStatus = 3, 1, 0 ) ) AS recordsCount,
			SUM( IF ( system.evaluationStatus = 3, 1, 0 ) ) AS evaluationCount,
			SUM( IF ( system.examinationStatus = 3, 1, 0 ) ) AS selfInspectionCount,
			(
			CASE
				MONTH ( system.createTime ) 
				WHEN 1 THEN
				'一月' 
				WHEN 2 THEN
				'二月' 
				WHEN 3 THEN
				'三月' 
				WHEN 4 THEN
				'四月' 
				WHEN 5 THEN
				'五月' 
				WHEN 6 THEN
				'六月' 
				WHEN 7 THEN
				'七月' 
				WHEN 8 THEN
				'八月' 
				WHEN 9 THEN
				'九月' 
				WHEN 10 THEN
				'十月' 
				WHEN 11 THEN
				'十一月' ELSE '十二月' 
			END 
			) AS MONTH
		FROM
			t_cpro_system AS system
			LEFT JOIN t_cpro_company AS company ON system.fkCompanyCode = company.companyCode
			LEFT JOIN t_cpro_system_code AS systemCodeAppIsInternet ON system.appIsInternet = systemCodeAppIsInternet.systemCode 
			AND systemCodeAppIsInternet.fkCodeType = 10
			LEFT JOIN t_cpro_system_code AS systemCodeInfoSysTypeConstruction ON system.fkInfoSysTypeCon = systemCodeInfoSysTypeConstruction.systemCode 
			AND systemCodeInfoSysTypeConstruction.fkCodeType = 7
			LEFT JOIN t_cpro_score AS score ON system.pkid = score.fkSystemId 
			AND score.deleteStatus = 1
			LEFT JOIN t_cpro_system_code AS systemCodeSprankLevel ON score.fkSprankLevel = systemCodeSprankLevel.systemCode 
			AND systemCodeSprankLevel.fkCodeType = 11
			LEFT JOIN t_cpro_records AS records ON system.pkId = records.fkSystemId
			LEFT JOIN t_cpro_evaluation AS evaluation ON system.pkId = evaluation.fkSystemId 
			AND evaluation.createTime = (
			SELECT
				MAX( eval.createTime ) 
			FROM
				t_cpro_evaluation eval 
			WHERE
				eval.fkSystemId = system.pkId 
				AND eval.deleteStatus = 1 
				LIMIT 1 
			)
			LEFT JOIN t_cpro_self_inspection AS selfInspection ON system.pkId = selfInspection.fkSystemId 
			AND selfInspection.createTime = (
			SELECT
				MAX( inspec.createTime ) 
			FROM
				t_cpro_self_inspection inspec 
			WHERE
				inspec.fkSystemId = system.pkId 
				AND inspec.deleteStatus = 1 
				LIMIT 1 
			)
			LEFT JOIN t_cpro_check AS examine ON system.pkId = examine.fkSystemId
			LEFT JOIN t_cpro_attach AS gradingAttch ON score.fkSystemId = gradingAttch.fkSystemId 
			AND score.pkId = gradingAttch.fkSyssonId 
			AND gradingAttch.fkAttachType = 'gradingReport'
			LEFT JOIN t_cpro_attach AS checkAttch ON score.fkSystemId = checkAttch.fkSystemId 
			AND score.pkId = checkAttch.fkSyssonId 
			AND checkAttch.fkAttachType = 'expertReview'
			LEFT JOIN t_cpro_attach AS evaluationAttch ON evaluation.fkSystemId = evaluationAttch.fkSystemId 
			AND evaluation.pkId = evaluationAttch.fkSyssonId 
			AND evaluationAttch.fkAttachType = 'evaluationPresentation'
			LEFT JOIN t_cpro_attach AS selfAttch ON selfInspection.fkSystemId = selfAttch.fkSystemId 
			AND selfInspection.pkId = selfAttch.fkSyssonId 
			AND selfAttch.fkAttachType = 'examinationReport'
			LEFT JOIN t_cpro_system_code AS gradingSystemCode ON system.gradingStatus = gradingSystemCode.systemCode 
			AND gradingSystemCode.fkCodeType = 25
			LEFT JOIN t_cpro_system_code AS examineSystemCode ON system.examineStatus = examineSystemCode.systemCode 
			AND examineSystemCode.fkCodeType = 25
			LEFT JOIN t_cpro_system_code AS recordSystemCode ON system.recordStatus = recordSystemCode.systemCode 
			AND recordSystemCode.fkCodeType = 25
			LEFT JOIN t_cpro_system_code AS evaluationSystemCode ON system.evaluationStatus = evaluationSystemCode.systemCode 
			AND evaluationSystemCode.fkCodeType = 25
			LEFT JOIN t_cpro_system_code AS examinationSystemCode ON system.examinationStatus = examinationSystemCode.systemCode 
			AND examinationSystemCode.fkCodeType = 25 
		<where>
		  system.deleteStatus = 1 
		  AND system.createTime!=''
		  AND company.deleteStatus = 1 
		  AND system.examineStatus!=5
		  AND system.gradingStatus!=4
		  AND system.recordStatus!=4
		  AND system.evaluationStatus!=4
		  AND system.examinationStatus!=4
		<if test="companyList != null">
        <![CDATA[
          AND company.companyCode IN  
        ]]>
        <foreach collection="companyList" item="item" index="index" open="(" separator="," close=")">
          <![CDATA[
            #{item}
          ]]>
        </foreach>
      	</if>
      	<if test="plateList != null">
        <![CDATA[
          AND company.fkPlateType IN  
        ]]>
        <foreach collection="plateList" item="item" index="index" open="(" separator="," close=")">
          <![CDATA[
            #{item}
          ]]>
        </foreach>
      	</if>
	    <if test="systemType != null and systemType == 1">
        <![CDATA[
           AND system.fkSystemType < 3
        ]]>
      	</if>
      	<if test="systemType != null and systemType == 2">
        <![CDATA[
           AND system.fkSystemType = 3
        ]]>
      	</if>
		<if test="year != null">
        <![CDATA[
          AND YEAR(system.createTime) = #{year}
        ]]>
      	</if>
    </where>
		GROUP BY MONTH(system.createTime)
	</select>
</mapper>