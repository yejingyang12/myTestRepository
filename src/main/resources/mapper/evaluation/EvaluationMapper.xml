<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.sinopec.smcc.cpro.evaluation.mapper.EvaluationMapper">
  <resultMap id="selectAllResultMap" type="com.sinopec.smcc.cpro.evaluation.entity.EvaluationListResult">
    <id column="evaluationId" property="evaluationId" />
    <result property="fkSystemId" column="fkSystemId" />
    <result property="systemName" column="systemName" />
    <result property="examName" column="examName" />
    <result property="examTime" column="examTime" />
    <result property="examYear" column="examYear" />
    <result property="examOrg" column="examOrg" />
    <result property="fkExamStatus" column="fkExamStatus" />
    <result property="fkExamResult" column="fkExamResult" />
    <result property="fkRectificationReu" column="fkRectificationReu" />
    <result property="rectificationDate" column="rectificationDate" />
    <result property="examReport" column="examReport" />
    <result property="examReportName" column="examReportName" />
    <result property="rectificationReport" column="rectificationReport" />
    <result property="rectificationReportName" column="rectificationReportName" />
  </resultMap>
  <select id="selectAllByEvaluationParam" parameterType="com.sinopec.smcc.cpro.evaluation.entity.EvaluationParam" resultMap="selectAllResultMap">
  	<![CDATA[
      SELECT 
        cproEvaluation.pkId AS evaluationId,
        cproEvaluation.fkSystemId,
        cproEvaluation.examName AS examName,
        cproEvaluation.examTime AS examTime,
        cproEvaluation.examYear AS examYear,
        cproEvaluation.examOrg AS examOrg,
        cproAttach.pkId AS examReport,
        cproAttach.attachName AS examReportName,
        cproEvaluation.fkExamStatus AS fkExamStatus,
        cproEvaluation.fkExamResult AS fkExamResult,
        cproEvaluation.fkRectificationReu AS fkRectificationReu,
        rectificationDate AS rectificationDate,
        cproAttachRectification.pkId AS rectificationReport,
        cproAttachRectification.attachName AS rectificationReportName
      FROM t_cpro_evaluation AS cproEvaluation
      LEFT JOIN t_cpro_system AS cproSystem ON cproSystem.pkId = cproEvaluation.fkSystemId
      LEFT JOIN  t_cpro_attach AS cproAttach 
        ON cproAttach.fkSyssonId = cproEvaluation.pkId 
        AND cproAttach.fkSystemId = cproEvaluation.fkSystemId 
        AND cproAttach.fkAttachType = 'evaluationPresentation'
    	LEFT JOIN  t_cpro_attach AS cproAttachRectification 
        ON cproAttachRectification.fkSyssonId = cproEvaluation.pkId 
        AND cproAttachRectification.fkSystemId = cproEvaluation.fkSystemId 
        AND cproAttachRectification.fkAttachType = 'rectificationReport' 
    ]]>
    <where>
      <![CDATA[
        cproEvaluation.deleteStatus = #{deleteStatus}
        AND cproEvaluation.fkSystemId = #{fkSystemId}
      ]]>
    </where>
  </select>

  <resultMap id="selectResultMap" type="com.sinopec.smcc.cpro.evaluation.entity.EvaluationResult">
    <id column="evaluationId" property="evaluationId" />
    <result property="fkSystemId" column="fkSystemId" />
    <result property="systemName" column="systemName" />
    <result property="examName" column="examName" />
    <result property="examTime" column="examTime" />
    <result property="examYear" column="examYear" />
    <result property="examOrg" column="examOrg" />
    <result property="examReport" column="examReport" />
    <result property="examReportName" column="examReportName" />
    <result property="fkExamStatus" column="fkExamStatus" />
    <result property="fkExamResult" column="fkExamResult" />
    <result property="fkRectificationReu" column="fkRectificationReu" />
    <result property="rectificationDate" column="rectificationDate" />
    <result property="rectificationReport" column="rectificationReport" />
    <result property="rectificationReportName" column="rectificationReportName" />
  </resultMap>
  <select id="selectSingleByEvaluationId" parameterType="com.sinopec.smcc.cpro.evaluation.entity.EvaluationParam" resultMap="selectResultMap">
  	<![CDATA[
      SELECT 
        cproEvaluation.pkId AS evaluationId,
        cproEvaluation.fkSystemId,
        cproEvaluation.examName AS examName,
        cproEvaluation.examTime AS examTime,
        cproEvaluation.examYear AS examYear,
        cproEvaluation.examOrg AS examOrg,
        cproAttach.pkId AS examReport,
        cproAttach.attachName AS examReportName,
        cproEvaluation.fkExamStatus AS fkExamStatus,
        cproEvaluation.fkExamResult AS fkExamResult,
        cproEvaluation.fkRectificationReu AS fkRectificationReu,
        rectificationDate AS rectificationDate,
        cproAttachRectification.pkId AS rectificationReport,
        cproAttachRectification.attachName AS rectificationReportName
      FROM t_cpro_evaluation AS cproEvaluation
      LEFT JOIN  t_cpro_attach AS cproAttach 
        ON cproAttach.fkSyssonId = cproEvaluation.pkId 
        AND cproAttach.fkSystemId = cproEvaluation.fkSystemId 
        AND cproAttach.fkAttachType = 'evaluationPresentation'
    	LEFT JOIN t_cpro_attach AS cproAttachRectification 
        ON cproAttachRectification.fkSyssonId = cproEvaluation.pkId 
        AND cproAttachRectification.fkSystemId = cproEvaluation.fkSystemId 
        AND cproAttachRectification.fkAttachType = 'rectificationReport' 
    ]]>
    <where>
     <![CDATA[
        AND cproEvaluation.pkId = #{evaluationId}
      ]]>
    </where>
    LIMIT 0,1
  </select>

  <insert id="saveEvaluationByEvaluationId" parameterType="com.sinopec.smcc.cpro.evaluation.entity.EvaluationParam">
    INSERT INTO t_cpro_evaluation (
      pkId,
      fkSystemId,
      examName,
      examTime,
      examYear,
      examOrg,
      fkExamStatus,
      fkExamResult,
      fkRectificationReu,
      rectificationDate,
      createTime,
      createUserName,
      deleteStatus
    )VALUES(
    <trim suffixOverrides=",">
      #{evaluationId},
      #{fkSystemId},
      <choose>
    		<when test="examName != null">
		      #{examName},
    		</when>
    		<otherwise>
    			DEFAULT,
    		</otherwise>
    	</choose>
    	<choose>
    		<when test="examTime != null">
		      #{examTime},
    		</when>
    		<otherwise>
    			DEFAULT,
    		</otherwise>
    	</choose>
    	<choose>
    		<when test="examYear != null">
		      #{examYear},
    		</when>
    		<otherwise>
    			DEFAULT,
    		</otherwise>
    	</choose>
    	<choose>
    		<when test="examOrg != null">
		      #{examOrg},
    		</when>
    		<otherwise>
    			DEFAULT,
    		</otherwise>
    	</choose>
    	<choose>
    		<when test="fkExamStatus != null">
		      #{fkExamStatus},
    		</when>
    		<otherwise>
    			DEFAULT,
    		</otherwise>
    	</choose>
      <choose>
    		<when test="fkExamResult != null">
		      #{fkExamResult},
    		</when>
    		<otherwise>
    			DEFAULT,
    		</otherwise>
    	</choose>
      <choose>
    		<when test="fkRectificationReu != null">
		      #{fkRectificationReu},
    		</when>
    		<otherwise>
    			DEFAULT,
    		</otherwise>
    	</choose>
      <choose>
    		<when test="rectificationDate != null">
		      #{rectificationDate},
    		</when>
    		<otherwise>
    			DEFAULT,
    		</otherwise>
    	</choose>
      #{createTime},
      <choose>
        <when test="createUserName != null and createUserName != ''">
          #{createUserName},
        </when>
        <otherwise>
          DEFAULT,
        </otherwise>
      </choose>
      <choose>
        <when test="deleteStatus != null">
          #{deleteStatus},
        </when>
        <otherwise>
          DEFAULT,
        </otherwise>
      </choose>
    </trim>
    ) ON DUPLICATE KEY UPDATE 
    <if test="examName != null">
	    examName=#{examName},
    </if>
    <if test="examTime != null">
	    examTime=#{examTime},
    </if>
    <if test="examYear != null">
	    examYear=#{examYear},
    </if>
    <if test="examOrg != null">
	    examOrg=#{examOrg},
    </if>
    <if test="fkExamResult != null">
	  	fkExamResult=#{fkExamResult},
    </if>
    <if test="rectificationDate != null">
	    rectificationDate=#{rectificationDate},
    </if>
    fkExamStatus=#{fkExamStatus},
    fkRectificationReu=#{fkRectificationReu}
  </insert>
  
  <update id="deleteEvaluationByEvaluationId" parameterType="com.sinopec.smcc.cpro.evaluation.entity.EvaluationParam">
    <![CDATA[
      UPDATE t_cpro_evaluation 
    ]]>
    <set>
      <![CDATA[
        deleteStatus = 2
      ]]>
    </set>
    <where>
     <![CDATA[
        AND pkId = #{evaluationId}
      ]]>
    </where>
  </update>
  
  <select id="selectSingleDetailsByEvaluationId" parameterType="com.sinopec.smcc.cpro.evaluation.entity.EvaluationParam" resultMap="selectResultMap">
    <![CDATA[
      SELECT 
        cproEvaluation.pkId AS evaluationId,
        cproEvaluation.fkSystemId,
        cproEvaluation.examName AS examName,
        cproEvaluation.examTime AS examTime,
        cproEvaluation.examYear AS examYear,
        cproEvaluation.examOrg AS examOrg,
        cproAttach.pkId AS examReport,
        cproAttach.attachName AS examReportName,
        cproEvaluation.fkExamStatus AS fkExamStatus,
        cproEvaluation.fkExamResult AS fkExamResult,
        cproEvaluation.fkRectificationReu AS fkRectificationReu,
        rectificationDate AS rectificationDate,
        cproAttachRectification.pkId AS rectificationReport,
        cproAttachRectification.attachName AS rectificationReportName
      FROM t_cpro_evaluation AS cproEvaluation
      LEFT JOIN  t_cpro_attach AS cproAttach 
        ON cproAttach.fkSyssonId = cproEvaluation.pkId 
        AND cproAttach.fkSystemId = cproEvaluation.fkSystemId 
        AND cproAttach.fkAttachType = 'evaluationPresentation'
      LEFT JOIN t_cpro_attach AS cproAttachRectification 
        ON cproAttachRectification.fkSyssonId = cproEvaluation.pkId 
        AND cproAttachRectification.fkSystemId = cproEvaluation.fkSystemId 
        AND cproAttachRectification.fkAttachType = 'rectificationReport' 
    ]]>
    <where>
     <![CDATA[
        AND cproEvaluation.pkId = #{evaluationId}
      ]]>
    </where>
    LIMIT 0,1
  </select>
  <select id="selectExamOrgCompany" parameterType="com.sinopec.smcc.cpro.evaluation.entity.EvaluationParam" resultMap="selectAllResultMap">
      SELECT
        DISTINCT
        examOrg
      FROM 
        t_cpro_evaluation
      WHERE
        deleteStatus = 1
  </select>
    <select id="selectAllByEvaluationSystemId" parameterType="com.sinopec.smcc.cpro.evaluation.entity.EvaluationParam" resultMap="selectAllResultMap">
    <![CDATA[
      SELECT 
        cproEvaluation.pkId AS evaluationId,
        cproEvaluation.fkSystemId,
        cproEvaluation.examName AS examName,
        cproEvaluation.examTime AS examTime,
        cproEvaluation.examYear AS examYear,
        cproEvaluation.examOrg AS examOrg,
        cproAttach.pkId AS examReport,
        cproAttach.attachName AS examReportName,
        cproEvaluation.fkExamStatus AS fkExamStatus,
        cproEvaluation.fkExamResult AS fkExamResult,
        cproEvaluation.fkRectificationReu AS fkRectificationReu,
        rectificationDate AS rectificationDate,
        cproAttachRectification.pkId AS rectificationReport,
        cproAttachRectification.attachName AS rectificationReportName
      FROM t_cpro_evaluation AS cproEvaluation
      LEFT JOIN t_cpro_system AS cproSystem ON cproSystem.pkId = cproEvaluation.fkSystemId
      LEFT JOIN  t_cpro_attach AS cproAttach 
        ON cproAttach.fkSyssonId = cproEvaluation.pkId 
        AND cproAttach.fkSystemId = cproEvaluation.fkSystemId 
        AND cproAttach.fkAttachType = 'evaluationPresentation'
      LEFT JOIN  t_cpro_attach AS cproAttachRectification 
        ON cproAttachRectification.fkSyssonId = cproEvaluation.pkId 
        AND cproAttachRectification.fkSystemId = cproEvaluation.fkSystemId 
        AND cproAttachRectification.fkAttachType = 'rectificationReport' 
    ]]>
    <where>
      <![CDATA[
        cproEvaluation.deleteStatus = 1
        AND cproEvaluation.fkSystemId = #{fkSystemId}
      ]]>
    </where>
  </select>
</mapper>
