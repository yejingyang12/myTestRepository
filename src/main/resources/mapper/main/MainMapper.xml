<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.sinopec.smcc.cpro.main.mapper.MainMapper">
  <resultMap id="MainListResult"
    type="com.sinopec.smcc.cpro.main.entity.MainListResult">
    <id column="pkid" property="id" />
    <result column="fkSystemId" property="fkSystemId" />
    <result column="fkBizSprankDegree" property="fkBizSprankDegree" />
    <result column="fkBizSprankLevel" property="fkBizSprankLevel" />
    <result column="fkBizSprankDegrees" property="fkBizSprankDegrees" />
    <result column="fkBizSprankLevels" property="fkBizSprankLevels" />
    <result column="appIsInternet" property="appIsInternet" />
    <result column="fkSpRanklevel" property="fkSpRanklevel" />
  </resultMap>
  <select id="selectAllByMainParam" parameterType="com.sinopec.smcc.cpro.main.entity.MainParam" resultMap="MainListResult">
    <![CDATA[
      SELECT
        system.pkId AS systemId, 
        system.systemName, 
        company.companyName, 
        company.fkPlateType AS plateType, 
        systemCodeInfoSysTypeConstruction.codeName AS InfoSysTypeConstruction, 
        systemCodeSprankLevel.codeName AS SprankLevel,
        score.fkSpRanklevel AS fkSpRanklevel,
        appIsInternet, 
        gradingStatus, 
        examineStatus, 
        recordStatus, 
        evaluationStatus,
        examinationStatus,
        company.pkId AS companyId,
        company.companyCode,
        gradingAttch.pkId AS gradingPkId,
        checkAttch.pkId AS checkPkId,
        evaluationAttch.pkId AS evaluationPkId,
        selfAttch.pkId AS selfPkId 
      FROM
        t_cpro_system AS system
      LEFT JOIN t_cpro_company AS company 
        ON system.fkCompanyCode = company.companyCode
      LEFT JOIN t_cpro_system_code AS systemCodeAppIsInternet
        ON system.appIsInternet = systemCodeAppIsInternet.systemCode 
        AND systemCodeAppIsInternet.fkCodeType = 10
      LEFT JOIN t_cpro_system_code AS systemCodeInfoSysTypeConstruction 
        ON system.fkInfoSysTypeCon = systemCodeInfoSysTypeConstruction.systemCode 
        AND systemCodeInfoSysTypeConstruction.fkCodeType = 7
      LEFT JOIN t_cpro_score AS score 
        ON system.pkid = score.fkSystemId
      LEFT JOIN t_cpro_system_code AS systemCodeSprankLevel 
        ON score.fkSprankLevel = systemCodeSprankLevel.systemCode 
        AND systemCodeSprankLevel.fkCodeType = 11
      LEFT JOIN t_cpro_records AS records 
        ON system.pkId = records.fkSystemId
      LEFT JOIN t_cpro_evaluation AS evaluation 
        ON system.pkId = evaluation.fkSystemId
        AND evaluation.createTime = (SELECT  MAX(eval.createTime) FROM t_cpro_evaluation eval 
                                     WHERE eval.fkSystemId = system.pkId  LIMIT 1)
      LEFT JOIN t_cpro_self_inspection AS selfInspection 
        ON system.pkId = selfInspection.fkSystemId
        AND selfInspection.createTime = (SELECT  MAX(inspec.createTime) FROM t_cpro_self_inspection inspec 
                                         WHERE inspec.fkSystemId =  system.pkId LIMIT 1)
      LEFT JOIN t_cpro_check AS examine 
        ON system.pkId = examine.fkSystemId
      LEFT JOIN t_cpro_attach AS gradingAttch 
        ON score.fkSystemId = gradingAttch.fkSystemId
        AND score.pkId = gradingAttch.fkSyssonId
        AND gradingAttch.fkAttachType = 'gradingReport'
      LEFT JOIN t_cpro_attach AS checkAttch 
        ON examine.fkSystemId = checkAttch.fkSystemId
        AND examine.pkId = checkAttch.fkSyssonId
        AND checkAttch.fkAttachType = 'expertReview'
      LEFT JOIN t_cpro_attach AS evaluationAttch 
        ON evaluation.fkSystemId = evaluationAttch.fkSystemId
        AND evaluation.pkId = evaluationAttch.fkSyssonId
        AND evaluationAttch.fkAttachType = 'evaluationPresentation'
      LEFT JOIN t_cpro_attach AS selfAttch 
        ON selfInspection.fkSystemId = selfAttch.fkSystemId
        AND selfInspection.pkId = selfAttch.fkSyssonId
        AND selfAttch.fkAttachType = 'expertReview'
      LEFT JOIN t_cpro_system_code AS gradingSystemCode 
        ON system.gradingStatus = gradingSystemCode.systemCode
        AND gradingSystemCode.fkCodeType = 25
	    LEFT JOIN t_cpro_system_code AS examineSystemCode 
	      ON system.examineStatus = examineSystemCode.systemCode
	      AND examineSystemCode.fkCodeType = 25
	    LEFT JOIN t_cpro_system_code AS recordSystemCode 
	      ON system.recordStatus = recordSystemCode.systemCode
	      AND recordSystemCode.fkCodeType = 25
	    LEFT JOIN t_cpro_system_code AS evaluationSystemCode 
	      ON system.evaluationStatus = evaluationSystemCode.systemCode
	      AND evaluationSystemCode.fkCodeType = 25
	    LEFT JOIN t_cpro_system_code AS examinationSystemCode 
	      ON system.examinationStatus = examinationSystemCode.systemCode
	      AND examinationSystemCode.fkCodeType = 25
    ]]>
    <where>
      <if test="customFiltering != null and customFiltering != ''">
        <bind name="customFiltering" value="'%' + _parameter.customFiltering + '%'" />
          <![CDATA[
             system.systemName LIKE #{customFiltering,jdbcType=VARCHAR} 
             AND (system.deleteStatus=1 
				     AND system.fkSystemType != 3
				     AND fkSystemIsMerge = 2)
             OR company.companyName LIKE #{customFiltering,jdbcType=VARCHAR}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR company.fkPlateType LIKE #{customFiltering,jdbcType=VARCHAR}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR systemCodeSprankLevel.codeName LIKE #{customFiltering,jdbcType=VARCHAR}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.appIsInternet LIKE #{customFiltering,jdbcType=VARCHAR}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR systemCodeInfoSysTypeConstruction.codeName LIKE #{customFiltering,jdbcType=VARCHAR}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR examine.fkExaminStatus LIKE #{customFiltering,jdbcType=VARCHAR}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.standardizedCode LIKE #{customFiltering,jdbcType=VARCHAR}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.gradeRecordSysName LIKE #{customFiltering,jdbcType=VARCHAR}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.sysBusSituationType LIKE #{customFiltering,jdbcType=VARCHAR}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.sysBusDescription LIKE #{customFiltering,jdbcType=VARCHAR}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.sysServiceSitScope LIKE #{customFiltering,jdbcType=VARCHAR}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.sysServiceSitObject LIKE #{customFiltering,jdbcType=VARCHAR}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.npCoverageRange LIKE #{customFiltering,jdbcType=VARCHAR}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.npNetworkProperties LIKE #{customFiltering,jdbcType=VARCHAR}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.executiveOfficeName LIKE #{customFiltering,jdbcType=VARCHAR}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.executiveDireCon LIKE #{customFiltering,jdbcType=VARCHAR}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.executiveDireConTel LIKE #{customFiltering,jdbcType=VARCHAR}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.changeReason LIKE #{customFiltering,jdbcType=VARCHAR}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR system.changeContent LIKE #{customFiltering,jdbcType=VARCHAR}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR gradingSystemCode.codeName LIKE #{customFiltering,jdbcType=VARCHAR}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR examineSystemCode.codeName LIKE #{customFiltering,jdbcType=VARCHAR}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR recordSystemCode.codeName LIKE #{customFiltering,jdbcType=VARCHAR}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR evaluationSystemCode.codeName LIKE #{customFiltering,jdbcType=VARCHAR}
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR examinationSystemCode.codeName LIKE #{customFiltering,jdbcType=VARCHAR}  
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
             OR systemCodeAppIsInternet.codeName LIKE #{customFiltering,jdbcType=VARCHAR} 
             AND (system.deleteStatus=1 
             AND system.fkSystemType != 3
             AND fkSystemIsMerge = 2)
          ]]>
      </if>
      AND system.deleteStatus=1 
      AND system.fkSystemType != 3
      <if test="customizedSearch != null ">
        <![CDATA[
          AND records.recordDate >= #{customizedSearch,jdbcType=DATE}
        ]]>
      </if>
      <!-- 受理备案单位 -->
      <if test="acceptCompany != null and acceptCompany != ''">
        <bind name="acceptCompany" value="'%' + _parameter.acceptCompany + '%'" />
        <![CDATA[
          AND records.acceptCompany LIKE #{acceptCompany,jdbcType=CHAR}
        ]]>
      </if>
      <if test="examOrg != null and examOrg != ''">
        <bind name="examOrg" value="'%' + _parameter.examOrg + '%'" />
        <![CDATA[
          AND evaluation.examOrg LIKE #{examOrg,jdbcType=CHAR}
        ]]>
      </if>
      <if test="auditTimeBegin != null ">
        <![CDATA[
          AND examine.executeTime >= #{auditTimeBegin,jdbcType=DATE}
        ]]>
      </if>
      <if test="auditTimeEnd != null ">
        <![CDATA[
          AND examine.executeTime <= #{auditTimeEnd,jdbcType=DATE}
        ]]>
      </if>
      <if test="recordDateBegin != null ">
        <![CDATA[
          AND records.recordDate >= #{recordDateBegin,jdbcType=DATE}
        ]]>
      </if>
      <if test="recordDateEnd != null ">
        <![CDATA[
          AND records.recordDate <= #{recordDateEnd,jdbcType=DATE}
        ]]>
      </if>
      <if test="examTimeBegin != null ">
        <![CDATA[
          AND evaluation.examTime >= #{examTimeBegin,jdbcType=DATE}
        ]]>
      </if>
      <if test="examTimeEnd != null ">
        <![CDATA[
          AND evaluation.examTime <= #{examTimeEnd,jdbcType=DATE}
        ]]>
      </if>
      <if test="rankTimeBegin != null ">
        <![CDATA[
          AND score.rankTime >= #{rankTimeBegin,jdbcType=DATE}
        ]]>
      </if>
      <if test="rankTimeEnd != null ">
        <![CDATA[
          AND score.rankTime <= #{rankTimeEnd,jdbcType=DATE}
        ]]>
      </if>
      <if test="inspectionDateBegin != null ">
        <![CDATA[
          AND selfInspection.inspectionDate >= #{inspectionDateBegin,jdbcType=DATE}
        ]]>
      </if>
      <if test="inspectionDateEnd != null ">
        <![CDATA[
          AND selfInspection.inspectionDate <= #{inspectionDateEnd,jdbcType=DATE}
        ]]>
      </if>
      <if test="fkCompanyCode != null and fkCompanyCode != ''">
        <![CDATA[
          AND system.fkCompanyCode = #{fkCompanyCode,jdbcType=CHAR}
        ]]>
      </if>
      <if test="systemId != null and systemId != ''">
        <![CDATA[
          AND system.pkId = #{systemId,jdbcType=CHAR}
        ]]>
      </if>
      <!-- 定级状态 -->
      <if test="systemCodeType != null and systemCodeType == '23'">
        <![CDATA[
          AND system.gradingStatus = #{gradingStatus,jdbcType=VARCHAR}
        ]]>
      </if>
      <!-- 审核状态  待审核-->
	    <if test="fkExaminStatus != null and fkExaminStatus == 1">
	        <![CDATA[
	          AND (examine.fkExaminStatus = 1 
	          OR  examine.fkExaminStatus = 2 )
	        ]]>
	    </if>
	    <!-- 审核状态 已审核-->
      <if test="fkExaminStatus != null and fkExaminStatus == 2">
          <![CDATA[
            AND examine.fkExaminStatus = 5
          ]]>
      </if>
      <!-- 审核状态 审核未通过-->
      <if test="fkExaminStatus != null and fkExaminStatus == 3">
          <![CDATA[
             AND (examine.fkExaminStatus = 3 
            OR  examine.fkExaminStatus = 4 )
          ]]>
      </if>
      <!-- 备案状态 -->
      <if test="systemCodeType != null and systemCodeType == '25'">
        <![CDATA[
          AND system.recordStatus = #{recordStatus,jdbcType=VARCHAR}
        ]]>
      </if>
      <!-- 测评状态 -->
      <if test="systemCodeType != null and systemCodeType == '26'">
        <![CDATA[
          AND system.evaluationStatus = #{evaluationStatus,jdbcType=VARCHAR}
        ]]>
      </if>
      <!-- 自查状态 -->
      <if test="systemCodeType != null and systemCodeType == '27'">
        <![CDATA[
          AND system.examinationStatus = #{examinationStatus,jdbcType=VARCHAR}
        ]]>
      </if>
      <if test="systemName != null and systemName != ''">
        <bind name="systemName" value="'%' + _parameter.systemName + '%'" />
        <![CDATA[
          AND system.systemName LIKE #{systemName,jdbcType=VARCHAR}
        ]]>
      </if>
      <if test="plateType != null and plateType != ''">
          <![CDATA[
            AND company.fkPlateType = #{plateType,jdbcType=VARCHAR}
          ]]>
      </if>
      <if test="sprankLevel != null and sprankLevel != ''">
          <![CDATA[
            AND score.fkSprankLevel = #{sprankLevel,jdbcType=VARCHAR}
          ]]>
      </if>
      <if test="subordinateProvinces != null and subordinateProvinces != ''">
          <![CDATA[
            AND company.fkSubordinatePro = #{subordinateProvinces,jdbcType=VARCHAR}
          ]]>
      </if>
    </where>
  </select>
  <update id="updateMainDeleteStatusBySystemId" parameterType="com.sinopec.smcc.cpro.main.entity.MainParam">
    UPDATE 
      t_cpro_system AS system
    LEFT JOIN t_cpro_company AS company
      ON system.fkCompanyCode = company.companyCode
    LEFT JOIN t_cpro_score AS score
      ON system.pkid = score.fkSystemId
    LEFT JOIN t_cpro_check AS cproCheck
      ON system.pkid = cproCheck.fkSystemId
    LEFT JOIN t_cpro_records AS records
      ON system.pkid = records.fkSystemId
    SET system.deleteStatus = 2,
      company.deleteStatus = 2,
      cproCheck.deleteStatus = 2,
      records.deleteStatus = 2,
      score.deleteStatus = 2
    <where>
      <if test="systemId != null and systemId != ''">
          <![CDATA[
             system.pkId = #{systemId}
          ]]>
      </if>
      <if test="companyId != null and companyId != ''">
          <![CDATA[
            AND company.pkId = #{companyId}
          ]]>
      </if>
    </where>
  </update>
  
  <select id="selectSystemName" parameterType="com.sinopec.smcc.cpro.main.entity.MainParam" resultMap="MainListResult">
    SELECT
      systemName,
      pkId AS systemId
    FROM 
      t_cpro_system
    WHERE deleteStatus=1 and fkSystemType != 3
  </select>
  <update id="updateApplicationChangeBySystemId" parameterType="com.sinopec.smcc.cpro.main.entity.MainParam">
    UPDATE 
      t_cpro_system 
    SET 
      fkChangeMatter = #{fkChangeMatter},
      changeReason = #{changeReason},
      changeContent = #{changeContent}
    <where>
      <if test="systemId != null and systemId != ''">
          <![CDATA[
             pkId = #{systemId}
          ]]>
      </if>
    </where>
  </update>
  <update id="updateSystemStatusBySystemId" parameterType="com.sinopec.smcc.cpro.main.entity.MainParam">
    <![CDATA[
      UPDATE t_cpro_system AS system
    ]]>
    <set>
      <if test="gradingStatus != null">
        <![CDATA[
         system.gradingStatus = #{gradingStatus},
        ]]>
      </if>
     <if test="examineStatus != null">
        <![CDATA[
         system.examineStatus = #{examineStatus},
        ]]>
      </if>
      <if test="recordStatus != null">
        <![CDATA[
         system.recordStatus = #{recordStatus},
        ]]>
      </if>
      <if test="evaluationStatus != null">
        <![CDATA[
         system.evaluationStatus = #{evaluationStatus},
        ]]>
      </if>
      <if test="examinationStatus != null">
        <![CDATA[
         system.examinationStatus = #{examinationStatus},
        ]]>
      </if>
    </set>
    <where>
      <![CDATA[
         pkId = #{systemId}
      ]]>
    </where>
  </update>
</mapper>